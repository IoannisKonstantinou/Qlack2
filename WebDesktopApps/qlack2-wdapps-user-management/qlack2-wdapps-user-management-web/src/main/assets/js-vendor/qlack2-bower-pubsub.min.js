!function(e){function t(e){g&&console.debug("QPubSub [",l,"]:",e)}function a(e){g&&console.debug("QPubSub [",l,"]:",e.data)}function i(){for(;void 0!==u&&(u.postMessage({clientID:l,msgType:m.CONTROL,msg:f.PING},"*"),u!==e.parent);)u=e.parent}function n(e,t){u.postMessage({clientID:l,msgType:m.PUB,topic:e,msg:t},"*")}function c(e,t){u.postMessage({clientID:l,msgType:m.SUB,msg:e},"*"),p[e]=t}function s(e){u.postMessage({clientID:l,msgType:m.UNSUB,msg:e},"*"),delete p[e]}function o(n,c){l=n,r=c,t("Initialising, server: "+c),e.addEventListener("message",function(e){switch(console.debug("Source: ",e.source),e.data.msgType){case m.CONTROL:e.data.msg==f.PING?e.data.clientID!=l&&(t("Received PING from [ "+e.data.clientID+" ]"),e.source.postMessage({clientID:l,msgType:m.CONTROL,msg:f.PONG},"*")):e.data.msg==f.PONG&&(u=e.source,t("Received PONG from [ "+e.data.clientID+" ]"),t("Setting as parent/server instance [ "+e.data.clientID+" ]"));break;case m.SUB:t("Received SUB from [ "+e.data.clientID+" ]"),I.push({topic:e.data.msg,clientID:e.data.clientID,clientAgent:e.source});break;case m.UNSUB:t("Received UNSUB from [ "+e.data.clientID+" ]"),I=_.filter(I,function(t){return t.topic!==e.data.topic&&t.clientID!==e.data.clientID});break;case m.PUB:t("Received PUB from [ "+e.data.clientID+" ] to topic [ "+e.data.topic+" ]");var i=_.filter(I,{topic:e.data.topic});t("Found [ "+i.length+" ] subscribers."),_.forEach(i,function(t){t.clientAgent.postMessage({topic:e.data.topic,clientID:l,originalClientID:e.data.clientID,msgType:m.CALLBACK,msg:e.data.msg},"*")});break;case m.CALLBACK:t("Received CALLBACK from [ "+e.data.clientID+" ] from original client [ "+e.data.originalClientID+" ] to topic [ "+e.data.topic+" ]"),p[e.data.topic](e.data);break;default:a(e)}},!1),r||i()}function d(e){g=e}var r,g=!0,l=void 0,u=e,p=[],I=[],m={CONTROL:1,PUB:2,SUB:3,CALLBACK:4,UNSUB:5},f={PING:"ping",PONG:"pong"};e.QPubSub={init:o,publish:n,subscribe:c,logEnabled:g,unsubscribe:s,setLogActive:d}}(window);